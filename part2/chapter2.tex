\chapter{アプリのしくみ}

% :::アプリ概要
\section{どういうアプリか？}
\begin{figure}[h]
  \centering
  \caption{アプリのようす}  
  \includegraphics[width=5cm]{images/dummy.png}
  \label{fig:アプリのようす}
\end{figure}
図
被験者は自身の運動を撮影し、
本アプリに流し込み、
撮影データをもとに、
抽象的な展の映像が出てくる
それを自由ん線でむすんだり、点を非表示にしたりを直感的なUIによってやることで、
ユーザが「形態」を編集する。
この形態のことを、「表情フォルム」と呼ぶ。
ただし、表情が一元的な現象（つまり物でも心でもない）のことである。
言うなれば、コインのような関係性である。
コインという全体（表情）における、「片面」という意味で「表情形態」とよぶのである。

編集してビジュアライズされた形態そのものは物世界に属するのだから、それ自体を表情と呼ぶべきではないだろう。
本アプリにおけるある種の物性をもっている。
ゲシュタルトが、
ノート機能に書く。
これらの仕様によって、自分との関係性に帰着させ、これが表情感得を促し、また、表情感得能力を培うことを目論んでいる。

・身体運動の撮影

モーションキャプチャもしくは通常のカメラで、身体運動を動画撮影する。



・アプリ用データへの整形し、DBに読み込ませる。（撮影データをアプリに読み込ませる）

モーションキャプチャで出力したデータを、アプリ用３次元データに整形する。この整形には、ノイズの削除やマーカデータの統合なども含めている。
撮影を通常カメラで行った場合は、動画データをもとに2Dデータを生成する「データ整形プログラム」によって行う（webアプリとは異なる）。
データ整形プログラムは、プログラミング言語pythonで記述し、マーカレスの身体運動動画から骨格検出する処理には、Google社製の「MediaPipe」\cite{mediapipe}をPythonライブラリとしてもちいた。
このプログラムは、アプリ本体というよりは、データ整形プログラムである。

・実践家が、アプリをプレイする（撮影した自身のデータや他者のデータで戯れる）

アプリをプレイする。データ選択画面からDBからデータを読み込むとプレイ画面に遷移するので、そこでプレイする。

・再び撮影する

モーキャプはpython処理プログラムによって、行っている。詳しくは付録を参照されたい。
手動で行い、

% :::システム概要
\section{システム構成}
まずは全体の構成を説明する。\ref{fig:システム構成}のとおりである。
本アプリは、webブラウザ上で作動するwebアプリである。
\footnote{webアプリは一般的に、フロントエンドとバックエンドの2つから構築される。
フロントエンドとは、ユーザのPCやスマホなどで動いているプログラム（すなわち、ユーザが直接目にふれ操作できる、インターネットにつながっていなくても作動する部分）であり、
バックエンドとは、インターネットのむこう側にある（巨大な）コンピュータ（サーバ）で動いているプログラムである。
たとえばYoutubeであれば、動画を選択・視聴・再生制御したり、コメントを書き込んだりなど、私たちユーザが目に見えて直接操作している部分が、フロントエンドに相当する。
いっぽうで、ユーザが動画を視聴できるのは、「Youtubeのサーバが、選択された動画を、DBからユーザのスマホへ動画データを送り返している」からである。
ユーザがコメント欄にコメントを投稿できるのは、「Youtubeのサーバが、送られてきたコメントを、DBに書き込み、DBに書き込まれたコメントをユーザのスマホへ送り返している」からである。
これら「」内に相当するのが、バックエンドである。}

\begin{figure}[h]
  \centering
  \caption{システム構成}  
  \includegraphics[width=5cm]{images/dummy.png}
  \label{fig:システム構成}
\end{figure}

\subsection{バックエンドについて}

バックエンドは、その大部分をGoogle社のFirebaseにおまかせしている。
Firebaseとは、Google社が提供するwebアプリ開発プラットフォームである
\footnote{いわゆる「mBaaS」（mobile Backend as a Service）に分類される。Firebaseは、バックエンドのハードウェア環境として、Google社保有のクラウド上サーバをもちいることができる}。
データベース（以下DBと書く）とホスティング（webサイトとして稼働させる）は、それぞれFirebaseのサービスである「Firestore」と「Firebase Hosting」をもちいている。


\subsection{フロントエンドについて}
アプリの実質的な仕様はこのフロントエンドである。
本アプリは、
フロントエンド部分は、主に以下のモジュールからなる。
それぞれのソースコードは付録を参照されたい。
\begin{description}
  \item [メインプログラム]\mbox{}\\
    DBから読み込んだいろんなデータをもっておく。ここから各モジュールで「参照」する。
  \item [映像描画モジュール]\mbox{}\\
    抽象映像（点や線）の描画を担当。グレー背景領域に対しての処理が本モジュールである。グレー背景領域は、HTMLの「canvas」要素である。
  \item [再生制御モジュール]\mbox{}\\
    映像の再生/一時停止/停止、コマ送り/戻し、再生速度設定、指定コマへの移動。
  \item [ノートモジュール]\mbox{}\\
    ノート機能を担うプログラム
  \item [ディスプレイ設定モジュール]\mbox{}\\
    その他ディスプレイ設定を担うプログラム
\end{description}


これらのプログラムは、プログラミング言語JavaScript・HTML・CSSにより記述した。
以下のJavaScriptライブラリ
\footnote{\label{foot:ライブラリ}
  当該プログラミング言語の、なんらか特定の処理群を寄せ集めてまとめた、いわば機能キットのようなファイルのことである。
しばしば、ライブラリは「パッケージ」や「アドオン」とも表記ゆれすることがある。
ライブラリを読み込めば、たとえばゼロからコードを書けば1000行を要するような処理さえも、わずか数行で書けてしまったりする。
開発をスピーディにしてくれ、モダンな開発では（とくに大規模な開発になればなるほど）、ライブラリを積極的に使用するのが主流と言える。

しかしである。「知」とは自分自身の手や身体でつくりあげてゆくべきものだ、という本研究の基本思想はここで強調しておきたい。
ライブラリの便利さに甘えすぎた結果「知の受け売り」に慣れてしまう、などということにないよう、自ら気をつけておく態度は重要であろう。
}
をもちいた。()内にバージョン情報を付記する。
\begin{description}
  \item [Vue.js(2.6.14)]\mbox{}\\
    モダンなweb開発におけるUIデザインに優れたライブラリである。
    HTMLとJavaScriptとの連携を高め、より少ないコードで書くことができる。
  \item [Vuetify(2.6.0)]\mbox{}\\
    Vueと連携する形で、モダンなweb開発におけるUIデザインに優れたライブラリである。テキストフィールド、テキストボックス、ボタンなど、基本的なUIの表現にもちいた。
    メインプログラムや、再生制御モジュールのUIデザインには、本ライブラリに頼った部分が大きい。
    なお、UIすべてをこのモジュールに頼ったわけではなく、後述する一部のUIパーツは著者自身でCSSで設計した。
  \item [p5.js(1.4.1)]\mbox{}\\
    インタラクティブなスケッチを描画できるライブラリである。
    \footnote{Javaベースのプログラミング言語Processingがもとになっており、それをJavaScriptに移植したものである。
    Processingは、コンピュータアートやメディアアートの制作にもちいられることも少なくない。
    }
    本アプリでは、映像描画部の表現にこれをもちいた。\cite{p5}
    映像描画モジュールは主に本ライブラリを活用して制作した。
\end{description}

% :::アプリの機能とユーザインタフェース
\section{機能とユーザインタフェースの詳細}
本アプリは、身体知の学びを支援したりや表情を感得を促すという目的があるからこそ、著者はそれをUIの細部の設計にも反映している。
ここでは操作方法に関して説明しよう。
ユーザが負担少なく直感的に操作できることは、UIにおいて重要である。マウス
\subsection{再生制御}

図\ref{fig:再生コントローラー}を参照してほしい。
\begin{figure}[h]
  \centering
  \includegraphics[width=5cm]{images/dummy.png}
  \caption{再生コントローラー}
  \label{fig:再生コントローラー}
\end{figure}


\begin{description}
  \item [再生/一時停止（スペースキー）]\mbox{}\\
  スペースキーをトグルスイッチにしている。これは、YouTubeやQuick Time Player（macOSのデフォルトの動画プレイヤー）など、よく使われる動画プレイヤーと同様にした。
  \item [コマ送り/戻し（左右矢印キー）]\mbox{}\\
  右矢印キーで1コマ送り、左矢印キーで1コマ戻る。
  \item [再生のスライダー（マウスドラッグ）]\mbox{}\\
  再生のスライダーを表示している。スライダーのツマミをマウスドラッグすると、コマを自在に移動できる。
  \item [指定コマへジャンプ（テキストフィールドに入力）]\mbox{}\\
  テキストフィールドに、指定のコマを半角数値で打ち込むと、そのコマにただちに移動できる。
  \item [再生速度変更（セレクタ選択）]\mbox{}\\
  再生速度を４段階から選択できる。速度は、×0.25、×0.5、×1、×2である。
\end{description}



\subsection{表情形態の編集}
\begin{figure}[h]
  \centering
  \includegraphics[width=5cm]{images/dummy.png}
  \caption{表情形態の編集}
  \label{fig:表情形態の編集}
\end{figure}
本アプリ最大の特徴である、表情形態の編集について説明する。
macOSならcommandキー（windowsならctrlキー）を押し下げている状態でのみ、ゲシュタルトの編集ができる。
この状態を「\textbf{編集モード}」と呼ぶ。これらのキーを離すと、自動的に編集モードから抜け、
「\textbf{再生モード}」に切り替わる。編集モードではないときはすべて再生モードである（モードはこの２つのみ）。
再生は再生モード時のみできる。
再生中にcommandキーを押すと、その瞬間に一時停止し、編集モードに切り替わる。
macOSのcommandキー・windowsOSのctrlキーは、様々なアプリにおいて、キーボードショートカット時の修飾キーとしてもっともよく採用されているものである。

編集モード中は、キャンバス背景のグレーが少し暗く・濃くなるようにしてある。
ささいな工夫に思えるかもしれないが、ユーザが「いまは編集モードだ」と直感的にわかるためには大事なことである。
この仕様そのものが表情に直結するというわけではないが、表情の感得がそもそも簡単ではない。、
この種のUIの細かな工夫は、ユーザがストレスなく心身をそこに集中できるよう促す、という観点からして重要だと考える。
以降の説明でも、同様の工夫については言及する。
編集モード中は、下に書く操作説明も表示されるようになっており、ユーザはいつでも編集のしかたを確認できる。
ゲシュタルトの編集は、commandキーと他の操作（キーまたはマウス操作）を組み合わせてやる。
基本的には編集とは、点どうしを結んだり/外したり、それぞれの点の表示/非表示にしたりすることを指す。
したがって、aaaaa

\begin{description}    
  \item [2点を連結/解除（点をクリック）]\mbox{}\\
  いずれかのマーカを一回クリック\footnote{  
    最近傍マーカは、「独自の計算法」によって「2次元のマウス位置座標」と「3次元のマーカ位置座標」との「距離」を算出することで同定している。  
    算出ルールの解説は、コンピュータグラフィックスの描画処理過程にまで踏み入った煩雑な計算を伴うので、付録（何番）に回す。
  
    残念ながらp5.jsライブラリでは、「3次元空間座標をもつ点群が、最終的にどのように、マウスと同じ画面2次元平面へと描画されてゆくか」
    という処理プロセスがブラックボックス化されている。だから、最近傍マーカ同定法を自前で実装する必要があったのだ。
    これはライブラリの弱点と言え、脚注\ref{foot:ライブラリ}で触れた問題と関連する。}

    すると、そのマーカが選択状態となって色づく。
    そのままcommandキーを離さずにキャンバス上でマウスカーソルを滑らせて、他マーカをマウスオンする。
    マウスオンすると、両点のあいだに線がx色で表示される。
    この状態で2点目をクリックすると、両点が線で結ばれる。
    連結済みの２点どうしに対して以上の操作をすると、２点の連結が解除される。

    ユーザがマウスオンしているマーカは赤くなり、かつ、半径が少し大きくなるようにした。
  
    \item [ある点の表示/非表示を切り替える（Dキー）]\mbox{}\\
    ユーザがマウスオンしているマーカの表示/非表示状態を切り替える（Dキーがトグルスイッチ的にはたらく）。
    非表示状態のマーカを実際に見えないようにするのは再生モード時においてのみであり、編集モード時は、表示状態マーカはそのまま見えて、非表示状態のマーカもそれより薄い色で見えるようにしている。

    \item [ある点を中心固定点にする（Cキー）]\mbox{}\\
    ユーザがマウスオンしているマーカを中心固定点にする。
    中心固定点とは、いわゆる3Dカメラの注視点のことであり、
    中心固定点となったマーカは、再生中でも画面中心で動かない（デフォルトでは、中心固定点はグローバル座標原点である）。
    このとき他の点・線群は、つねに中心固定点を原点としたローカル座標系に描画されることとなる。
    \footnote{
      たとえば、デフォルト状態で動きまわるマーカAと静止したマーカBがあったとしよう
      これを動点Aを中心固定点にすれば、マーカAが静止点に、マーカBが動きまわるようになるわけである。
      }    
    ゆえにどこを中心固定点にするかによって、再生時の全体の点・線群のふるまいは当然異なってくる。
    この設計では、中心固定点の変化に応じて多彩なゲシュタルトが生まれるのを促したいのである。

  \item [ながめる立場を変える（マウスドラッグ・マウスウィール）]\mbox{}\\
  マウスではなくトラックパッドをつかう場合は、スワイプ動作でみる角度を変え、ピンチ動作でズームin/outする。
  
  「カメラ」と呼ばないのは、意図的である。本アプリではいわゆる3D空間を映し出す「カメラ」は、単なる客観的観測者にとどめていないということだ。
  いわゆるオブジェクトは、観測者と無関係に存在するが、
  ゲシュタルト（表情）は、観測者との関係性として成り立つものである。ゆに、

  カメラのふるまいの内部的なルールとしては、以下の図のように配置されており、動作ルールにより、直感的操作を可能としている。
  マウスドラッグとピンチを、「極座標上を動くのとチョクに対応し動作」にしてある。


  
  \item [表示中のすべての点どうしを結ぶ/外す（Aキー）]\mbox{}\\
  表示中の点群の連結状態を一斉に変更する。表示中の点群の連結状態は以下の3状態のどれかに相当するので、
  Aキーをトリガーにして、これら3状態間でサイクリックに状態遷移が起こる。

  どの点どうしも連結されていない場合、すべての点どうしを連結する。

  一部の点どうしが連結されている場合は、すべての点どうしの連結を解除する。

  すべての点どうしが連結されている場合は、すべての点どうしの連結を解除する。

  
  \item [すべての点を表示→孤立点のみ非表示→すべての点を非表示→...（繰り返し）...]\mbox{}\\
  孤立点とは、ほかのどの点とも連結されていない点のことである。
  孤立点の非表示とはすなわち、連結されている点のみ表示するのは、実際の探るときにありがたい機能である。
\end{description}

\subsection{その他ディスプレイ設定メニュー}
tabキーがトグルスイッチとなり、本メニューが画面左側から出し入れされる。
「その他」とは言っても、表情感得において無関係というわけではもちろんない。
図を参照されたい。

\todo{こうやってtodoを書くよ。}
図\ref{fig:再生コントローラー}を参照してほしい。
\begin{figure}[h]
  \centering
  \includegraphics[width=5cm]{images/dummy.png}
  \caption{その他のディスプレイ設定}
  \label{fig:その他のディスプレイ設定}
\end{figure}

\subsection{ノート機能}
ノート機能について
図で説明。一般的な状態を図にする。
それぞれのパーツを指し示して、その解説をする。
ちゃんとそれぞれのUIが表情とどう関連しているのかを、明確に説明すること！

\subsection{操作ガイドUI}
2種類の操作ガイドUIがある。
アップバーのキーボードボタンと、
ちなみに哲学が表示される。
スナックバーと

% :::データベース概要
\section{データベース概要}
DBの構成を説明する。Firestoreは、データを階層構造にして保管する
\footnote{いわゆるNoSQLである。}。
それにならって、以下に構造を説明する。

・身体運動コレクション


・ノートデータ


・会員コレクション

これらを連携させながら、webアプリとして望ましい諸機能を実現している。具体的にどういう局面で連携しているのかは、ユーザインタフェースの章で説明する。

% :::アプリの開発環境
\section{開発環境}
本アプリの開発にもちいたPCは、Apple社のiMac2020(Retina 5K, 27-inch)である。このハードウェア詳細は以下である。
\begin{itemize}
  \item {プロセッサ: 3.8 GHz 8コアIntel Core i7}
  \item {グラフィックス: AMD Radeon Pro 5500 XT 8 GB + }
  \item {メモリ: 40 GB 2667 MHz DDR4}  
\end{itemize}
プログラミングのエディタには、Microsoft社のVisual Studio Code\cite{vscode}をもちいた。





